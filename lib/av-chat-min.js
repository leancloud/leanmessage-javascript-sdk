!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.AVChatClient=e()}}(function(){var e,t,n;return function r(e,t,n){function i(o,u){if(!t[o]){if(!e[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(s)return s(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=t[o]={exports:{}};e[o][0].call(l.exports,function(t){var n=e[o][1][t];return i(n?n:t)},l,l.exports,r,e,t,n)}return t[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,n){function s(e){function p(e,t){return r.resolve({watchingPeerIds:t||[]})}function d(e,t,n,i){return r.resolve({groupPeerIds:i||[]})}function v(e){if(!e)throw new Error("settings");if(!e.appId)throw new Error("settings.appId");if(!e.peerId)throw new Error("settings.peerId");if(e.auth&&typeof e.auth!="function")throw new Error("sesstings.auth");if(e.groupAuth&&typeof e.groupAuth!="function")throw new Error("sesstings.groupAuth");n=e||{},n.auth=e.auth||p,n.groupAuth=e.groupAuth||d,n.watchingPeerIds=e.watchingPeerIds||[],n.sp=e.sp,n.server=e.server,u=[],t=new i,l=6e4}function m(e,t){var r="http://";typeof window!="undefined"&&window.location&&window.location.protocol=="https:"&&(r="https://");var i=r+"router-g0-push.avoscloud.com/v1/route?appId="+e;return n.server&&n.server=="us"&&(i=r+"router-a0-push.avoscloud.com/v1/route?appId="+e),t&&(i+="&secure=1"),o(i)}function g(){return a&&new Date<a.expires?new r(function(e,r){f=new WebSocket(a.server),b("connectopen",function(){r()}),f.onopen=function(){h.length>0&&clearTimeout(h.shift()[1]),e(a)},f.onclose=function(){E(),t.emit("close")},f.onmessage=function(e){var r=JSON.parse(e.data),i=r.op?r.cmd+r.op:r.cmd;i||(i="{}"),u.length>0&&u[0][0]===i&&u.shift()[1](r),h.length>0&&h[0][0]==i&&clearTimeout(h.shift()[1]);if(r.cmd=="session")(r.op=="opened"||r.op=="added")&&t.emit("online",r.onlineSessionPeerIds);else if(r.cmd=="presence")r.status=="on"?t.emit("online",r.sessionPeerIds):r.status=="off"&&t.emit("offline",r.sessionPeerIds);else if(r.cmd=="direct"){t.emit("message",r);var s={cmd:"ack",peerId:n.peerId,appId:n.appId,ids:[].concat(r.id)},o=JSON.stringify(s);f.send(o)}else r.cmd=="room"&&(r.op=="members-joined"?t.emit("membersJoined",r):r.op=="members-left"?t.emit("membersLeft",r):r.op=="joined"?t.emit("joined",r):r.op=="left"&&t.emit("left",r))}}):m(n.appId,n.secure).then(function(e){return a=e,a.expires=Date.now()+a.ttl*1e3,g()})}function y(){return n.auth(n.peerId,n.watchingPeerIds,n.sp).then(function(e){return n.watchingPeerIds=e.watchingPeerIds,S("session","open",{sessionPeerIds:e.watchingPeerIds,s:e.s,t:e.t,n:e.n,sp:e.sp})})}function b(e,t){h.push([e,setTimeout(function(){t&&t(e+"timeout"),E()},1e4)])}function w(){clearTimeout(w.handle),w.handle=setTimeout(function(){f.readyState==1&&(f.send("{}"),b("{}"),w())},l)}function E(){f.close(),clearTimeout(w.handle),h.forEach(function(e,t){clearTimeout(e[1])}),u.forEach(function(e){e[2]()}),h=[],u=[]}function S(e,t,i){w();var s={cmd:e,peerId:n.peerId,appId:n.appId};t&&(s.op=t);if(i)for(k in i)s[k]=i[k];if(!f)return r.reject();if(f.readyState!=1)return r.reject(f.readyState);f.send(JSON.stringify(s));var o=typeof t=="undefined"?e:e+t;return e=="direct"&&i.transient==1||["sessionremove","sessionclose"].indexOf(o)>-1?r.resolve():new r(function(e,t){u.push([c[o]||o,e,t]),b(c[o]||o,t)})}if(this instanceof s==0)return new s(e);var t,n,u,a,f,l,c={direct:"ack",sessionopen:"sessionopened",sessionadd:"sessionadded",sessionquery:"sessionquery-result",roomjoin:"roomjoined",roominvite:"roominvited",roomleave:"roomleft",roomkick:"roomkicked"},h=[];v(e),this.open=function(){return f&&f.readyState==0?r.reject(0):f&&f.readyState==1?r.resolve():(h.forEach(function(e,t){clearTimeout(e[1])}),h=[],g().then(function(){return y()}))},this.close=function(){return S("session","close"),E(),r.resolve()},this.send=function(e,t,n){var r={msg:e,toPeerIds:[].concat(t)};return typeof n!="undefined"&&n==1&&(r.transient=n),S("direct",undefined,r)},this.on=function(e,n){t.on(e,n)},this.watch=function(e){return n.auth(n.peerId,[].concat(e)).then(function(e){var t=[].concat(e.watchingPeerIds);return t.forEach(function(e,t){n.watchingPeerIds.indexOf(e)==-1&&n.watchingPeerIds.push(e)}),S("session","add",{sessionPeerIds:[].concat(e.watchingPeerIds),s:e.s,t:e.t,n:e.n})})},this.unwatch=function(e){return e.forEach(function(e,t){n.watchingPeerIds.indexOf(e)>-1&&n.watchingPeerIds.splice(n.watchingPeerIds.indexOf(e),1)}),S("session","remove",{sessionPeerIds:[].concat(e)})},this.getStatus=function(e){return S("session","query",{sessionPeerIds:[].concat(e)})},this.joinGroup=function(e){return n.groupAuth(n.peerId,e,"join","").then(function(t){return S("room","join",{roomId:e})})},this.sendToGroup=function(e,t,n){var r={msg:e,roomId:t};return typeof n!="undefined"&&n==1&&(r.transient=n),S("direct",undefined,r)},this.inviteToGroup=function(e,t){return n.groupAuth(n.peerId,e,"invite",t).then(function(t){return S("room","invite",{roomId:e,roomPeerIds:[].concat(t.groupPeerIds)})})},this.kickFromGroup=function(e,t){return n.groupAuth(n.peerId,e,"kick",t).then(function(n){return S("room","kick",{roomId:e,roomPeerIds:[].concat(t)})})},this.leaveGroup=function(e){return S("room","leave",{roomId:e})}}function o(e){return typeof jQuery!="undefined"?r.resolve(jQuery.getJSON.call(jQuery,e+="&cb=?")):new r(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.onload=function(){r.status==200?t(JSON.parse(r.responseText)):n(Error(r.statusText))},r.onerror=function(){n(Error("Network Error"))},r.send()})}XMLHttpRequest=typeof XMLHttpRequest=="undefined"?e("xmlhttprequest").XMLHttpRequest:XMLHttpRequest,WebSocket=typeof WebSocket=="undefined"||WebSocket==null?e("ws"):WebSocket;var r=e("es6-promise").Promise,i=e("events").EventEmitter;t.exports=s},{"es6-promise":2,events:12,ws:undefined,xmlhttprequest:undefined}],2:[function(e,t,n){"use strict";var r=e("./promise/promise").Promise,i=e("./promise/polyfill").polyfill;n.Promise=r,n.polyfill=i},{"./promise/polyfill":6,"./promise/promise":7}],3:[function(e,t,n){"use strict";function s(e){var t=this;if(!r(e))throw new TypeError("You must pass an array to all.");return new t(function(t,n){function u(e){return function(t){a(e,t)}}function a(e,n){r[e]=n,--s===0&&t(r)}var r=[],s=e.length,o;s===0&&t([]);for(var f=0;f<e.length;f++)o=e[f],o&&i(o.then)?o.then(u(f),n):a(f,o)})}var r=e("./utils").isArray,i=e("./utils").isFunction;n.all=s},{"./utils":11}],4:[function(e,t,n){(function(e,t){"use strict";function o(){return function(){e.nextTick(l)}}function u(){var e=0,t=new i(l),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function a(){return function(){s.setTimeout(l,1)}}function l(){for(var e=0;e<f.length;e++){var t=f[e],n=t[0],r=t[1];n(r)}f=[]}function h(e,t){var n=f.push([e,t]);n===1&&c()}var r=typeof window!="undefined"?window:{},i=r.MutationObserver||r.WebKitMutationObserver,s=typeof t!="undefined"?t:this===undefined?window:this,f=[],c;typeof e!="undefined"&&{}.toString.call(e)==="[object process]"?c=o():i?c=u():c=a(),n.asap=h}).call(this,e("_process"),typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{_process:13}],5:[function(e,t,n){"use strict";function i(e,t){if(arguments.length!==2)return r[e];r[e]=t}var r={instrument:!1};n.config=r,n.configure=i},{}],6:[function(e,t,n){(function(t){"use strict";function s(){var e;typeof t!="undefined"?e=t:typeof window!="undefined"&&window.document?e=window:e=self;var n="Promise"in e&&"resolve"in e.Promise&&"reject"in e.Promise&&"all"in e.Promise&&"race"in e.Promise&&function(){var t;return new e.Promise(function(e){t=e}),i(t)}();n||(e.Promise=r)}var r=e("./promise").Promise,i=e("./utils").isFunction;n.polyfill=s}).call(this,typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{"./promise":7,"./utils":11}],7:[function(e,t,n){"use strict";function d(e){if(!o(e))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof d))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],v(e,this)}function v(e,t){function n(e){T(t,e)}function r(e){C(t,e)}try{e(n,r)}catch(i){r(i)}}function m(e,t,n,r){var i=o(n),s,u,a,f;if(i)try{s=n(r),a=!0}catch(l){f=!0,u=l}else s=r,a=!0;if(x(t,s))return;i&&a?T(t,s):f?C(t,u):e===b?T(t,s):e===w&&C(t,s)}function E(e,t,n,r){var i=e._subscribers,s=i.length;i[s]=t,i[s+b]=n,i[s+w]=r}function S(e,t){var n,r,i=e._subscribers,s=e._detail;for(var o=0;o<i.length;o+=3)n=i[o],r=i[o+t],m(t,n,r,s);e._subscribers=null}function x(e,t){var n=null,r;try{if(e===t)throw new TypeError("A promises callback cannot return that same promise.");if(s(t)){n=t.then;if(o(n))return n.call(t,function(n){if(r)return!0;r=!0,t!==n?T(e,n):N(e,n)},function(t){if(r)return!0;r=!0,C(e,t)}),!0}}catch(i){return r?!0:(C(e,i),!0)}return!1}function T(e,t){e===t?N(e,t):x(e,t)||N(e,t)}function N(e,t){if(e._state!==g)return;e._state=y,e._detail=t,r.async(k,e)}function C(e,t){if(e._state!==g)return;e._state=y,e._detail=t,r.async(L,e)}function k(e){S(e,e._state=b)}function L(e){S(e,e._state=w)}var r=e("./config").config,i=e("./config").configure,s=e("./utils").objectOrFunction,o=e("./utils").isFunction,u=e("./utils").now,a=e("./all").all,f=e("./race").race,l=e("./resolve").resolve,c=e("./reject").reject,h=e("./asap").asap,p=0;r.async=h;var g=void 0,y=0,b=1,w=2;d.prototype={constructor:d,_state:undefined,_detail:undefined,_subscribers:undefined,then:function(e,t){var n=this,i=new this.constructor(function(){});if(this._state){var s=arguments;r.async(function(){m(n._state,i,s[n._state-1],n._detail)})}else E(this,i,e,t);return i},"catch":function(e){return this.then(null,e)}},d.all=a,d.race=f,d.resolve=l,d.reject=c,n.Promise=d},{"./all":3,"./asap":4,"./config":5,"./race":8,"./reject":9,"./resolve":10,"./utils":11}],8:[function(e,t,n){"use strict";function i(e){var t=this;if(!r(e))throw new TypeError("You must pass an array to race.");return new t(function(t,n){var r=[],i;for(var s=0;s<e.length;s++)i=e[s],i&&typeof i.then=="function"?i.then(t,n):t(i)})}var r=e("./utils").isArray;n.race=i},{"./utils":11}],9:[function(e,t,n){"use strict";function r(e){var t=this;return new t(function(t,n){n(e)})}n.reject=r},{}],10:[function(e,t,n){"use strict";function r(e){if(e&&typeof e=="object"&&e.constructor===this)return e;var t=this;return new t(function(t){t(e)})}n.resolve=r},{}],11:[function(e,t,n){"use strict";function r(e){return i(e)||typeof e=="object"&&e!==null}function i(e){return typeof e=="function"}function s(e){return Object.prototype.toString.call(e)==="[object Array]"}var o=Date.now||function(){return(new Date).getTime()};n.objectOrFunction=r,n.isFunction=i,n.isArray=s,n.now=o},{}],12:[function(e,t,n){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||undefined}function i(e){return typeof e=="function"}function s(e){return typeof e=="number"}function o(e){return typeof e=="object"&&e!==null}function u(e){return e===void 0}t.exports=r,r.EventEmitter=r,r.prototype._events=undefined,r.prototype._maxListeners=undefined,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!s(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,s,a,f;this._events||(this._events={});if(e==="error")if(!this._events.error||o(this._events.error)&&!this._events.error.length)throw t=arguments[1],t instanceof Error?t:TypeError('Uncaught, unspecified "error" event.');n=this._events[e];if(u(n))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:r=arguments.length,s=new Array(r-1);for(a=1;a<r;a++)s[a-1]=arguments[a];n.apply(this,s)}else if(o(n)){r=arguments.length,s=new Array(r-1);for(a=1;a<r;a++)s[a-1]=arguments[a];f=n.slice(),r=f.length;for(a=0;a<r;a++)f[a].apply(this,s)}return!0},r.prototype.addListener=function(e,t){var n;if(!i(t))throw TypeError("listener must be a function");this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t;if(o(this._events[e])&&!this._events[e].warned){var n;u(this._maxListeners)?n=r.defaultMaxListeners:n=this._maxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),typeof console.trace=="function"&&console.trace())}return this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}if(!i(t))throw TypeError("listener must be a function");var n=!1;return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var n,r,s,u;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;n=this._events[e],s=n.length,r=-1;if(n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(o(n)){for(u=s;u-->0;)if(n[u]===t||n[u].listener&&n[u].listener===t){r=u;break}if(r<0)return this;n.length===1?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[e]&&delete this._events[e],this;if(arguments.length===0){for(t in this._events){if(t==="removeListener")continue;this.removeAllListeners(t)}return this.removeAllListeners("removeListener"),this._events={},this}n=this._events[e];if(i(n))this.removeListener(e,n);else while(n.length)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){var t;return!this._events||!this._events[e]?t=[]:i(this._events[e])?t=[this._events[e]]:t=this._events[e].slice(),t},r.listenerCount=function(e,t){var n;return!e._events||!e._events[t]?n=0:i(e._events[t])?n=1:n=e._events[t].length,n}},{}],13:[function(e,t,n){function i(){}var r=t.exports={};r.nextTick=function(){var e=typeof window!="undefined"&&window.setImmediate,t=typeof window!="undefined"&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;if((t===window||t===null)&&e.data==="process-tick"){e.stopPropagation();if(n.length>0){var r=n.shift();r()}}},!0),function(t){n.push(t),window.postMessage("process-tick","*")}}return function(t){setTimeout(t,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=i,r.addListener=i,r.once=i,r.off=i,r.removeListener=i,r.removeAllListeners=i,r.emit=i,r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")}},{}]},{},[1])(1)});