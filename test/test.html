<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Message </title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-2.1.1.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  <script src="promise-1.0.0.min.js"></script>
  <script src="../lib/chat.js"></script>

  <style>
  .online {
    border-left: 5px solid green;
  }
  .offline{
    border-left: 5px solid grey;
  }
  .online.btn-group>.btn:first-child,.offline.btn-group>.btn:first-child{
    border-top-left-radius :0;
    border-bottom-left-radius :0;
  }
  </style>
</head>
<body>
  <div class="container">
    <h2>Message Test</h2>
    <p></p>
    <hr>
    <h4>Basic</h4>
    <div class="form-inline" >
      <div class="form-group">
        <label for="">peerId: </label>
        <input type="text" id="sender" class="form-control">
      </div>
      <div class="form-group">
        <label for="">watchingPeer: </label>
        <input type="text " id="watchingPeer" class="form-control">
      </div>
      <button id="new" class="btn btn-default"> new Client </button>
      <button id="start" class="btn btn-default"> open </button>
      <button id="close" class="btn btn-warning"> close </button>
      <span id="connect-status" class="text-primary">not connected</span>
      <button id="addwatch" class="btn btn-default"> watch </button>
      <button id="removewatch" class="btn btn-default"> unwatch </button>
    </div>
    <hr>
    <h4>PeerStatus</h4>
    <div class="row">
      <div class="col-md-6">
        <h5>WatchingPeers</h5>
        <div id="allwatcher">
      <!-- Split button -->

        </div>
      </div>
      <div class="col-md-6">
        <h5>getPeerStatus</h5>
        <div class="form-inline">
          <div class="form-group">
            <input type="text" class="form-control" id="querypeer">
          </div>
          <button class="btn btn-default" id="getstatus">getStatus</button>
        </div>
      </div>
    </div>

    <hr>
    <div class="row">
      <div class="col-md-6">
        <h4>Message to <span class="text-primary" id="to-peer-id"></span></h4>
        <div  class="form-inline">
          <div class="form-group">
            <input type="text" class="form-control" id="msg">
          </div>
          <button class="btn btn-default" id="sendbtn">send</button>
        </div>

      </div>

    </div>
    <div class="row">
      <div class="col-md-6">
        <h4>Message Sent</h4>
        <div id="msgsent">

        </div>
      </div>

      <div class="col-md-6">
        <h4>Message Receive</h4>
        <div id="msgreceive">

        </div>
      </div>
    </div>



  </div>



<!-- <div class="btn-group offline" id="peer-@peerId@">
  <button type="button" class="btn btn-default">@peerId@</button>
  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
    <span class="caret"></span>
    <span class="sr-only">Toggle Dropdown</span>
  </button>
  <ul class="dropdown-menu" role="menu">
    <li><a onclick="setSendTo('@peerId@')">chat</a></li>
    <li><a onclick="chat.removeWatchingPeer('@peerId@')">removeWatchingPeer</a></li>
  </ul>
</div> -->
<script type="tpl" id="watcher-tpl">
<button type="button" class="btn btn-default" id="peer-@peerId@" onclick="setSendTo('@peerId@')">@peerId@</button>
</script>




<script>
  var appid = '9zcwm6xjbg3iajmky2xpef9wfxjwatqte1my06xdd83k26nc';
  var peerId = $('#sender').val() || 'testuser'+Math.random();
  var toPeerId;
  // var watchingPeer = $('#watchingPeer').val().split(',');
  var chat;
  $('#new').click(function(){
    chat = new WebClient({
      appId: appid,
      peerId: $('#sender').val() || 'testuser'+Math.random(),
      watchingPeer: $('#watchingPeer').val().split(','),
      auth: auth
    });
    chat.on('message',function(data){
      $('#msgreceive').append(JSON.stringify(data));
      $('#msgreceive').append('<br>');
      // console.log(data);
    });
    chat.on('online', function(peers){
      for(var i=0;i<peers.length;i++){
        $('#peer-'+peers[i]).removeClass('offline');
        $('#peer-'+peers[i]).addClass('online');
      }
    });
    chat.on('offline', function(peers){
      for(var i=0;i<peers.length;i++){
        $('#peer-'+peers[i]).removeClass('online');
        $('#peer-'+peers[i]).addClass('offline');
      }
    });
    chat.on('close', function(){
      alert('connection closed')
      $('#connect-status').text('not connected');
      $('.online').removeClass('online').addClass('offline');
      // chat.open().then(function(){
      //   $('#status').append('Opened');
      //   $('#status').append('<br>');
      //   $('#connect-status').text('connected')
      // },function(){
      //   alert('open failure')
      // });
    });
  });
  $('#start').click(function(){


    $('#allwatcher').empty();
    addWatchingPeer($('#watchingPeer').val().split(','));
    chat.open().then(function(){
      $('#status').append('Opened');
      $('#status').append('<br>');
      $('#connect-status').text('connected')
    },function(){
      alert('open failure')
    });



  });

  $('#close').click(function(){
    chat.close().then(function(){
      $('#connect-status').text('not connected');
      $('.online').removeClass('online').addClass('offline');
    });
  })

  $('#addwatch').click(function(){
    addWatchingPeer($('#watchingPeer').val().split(','));
    chat.watch($('#watchingPeer').val().split(',')).then(function(){

    },function(){
      alert('watch failure')
    });
  });

  $('#removewatch').click(function(){
    removeWatchingPeer($('#watchingPeer').val().split(','));
    chat.unwatch($('#watchingPeer').val().split(','));
  });

  function setSendTo(peerId){
    toPeerId = peerId;
    $('#to-peer-id').text(toPeerId);
  }
  function addWatchingPeer(peers){
    for(var i=0;i<peers.length;i++){
      if(!peers[i]){
        return;
      }
      var str = $('#watcher-tpl').html().replace(/@peerId@/g,peers[i]);
      $('#allwatcher').append(str);
    }
  }

  function removeWatchingPeer(peers){
    peers = [].concat(peers);
    for(var i=0;i<peers.length;i++){
      if(!peers[i]){
        return;
      }
      $('#peer-'+peers[i]).remove();
    }
  }

  $('#sendbtn').click(function(){
    chat.send($('#msg').val(),toPeerId).then(function(){
      $('#msgsent').append(JSON.stringify({
        msg: $('#msg').val(),
        toPeerId: toPeerId
      }));
      $('#msgsent').append('<br>');
      $('#msg').val('');
      // $('#status').append('Msg Sended');
      // $('#status').append('<br>');
    },function(){
      alert("send failure!!!")
    });
  });

  $('#getstatus').click(function(){
    chat.getStatus($('#querypeer').val().split(',')).then(function(data){
      console.log(data);
    })
  });

  function auth(peerId,watchingPeers){
    return new Promise(function(resolve,reject){
      $.post('http://localhost:8080/sign',{
        self_id : peerId,
        watch_ids: watchingPeers.join(':')
      }).success(function(data){
        console.log(data.watch_ids)
         resolve({
          n: data.nonce,
          t: data.timestamp,
          s: data.signature,
          watchingPeer: data.watch_ids.split(':')
         });
      }).error(function(err){
        reject(err);
      })
    })

  }
</script>
</body>
</html>